# Expects azuresdk-github-pat is set to the PAT for azure-sdk
# Expects the buildtools to be cloned

parameters:
  BaseBranchName: $(Build.SourceBranch)
  PRBranchName: create_tag_label
  PROwner: sima-zhu
  CommitMsg: not-specified
  RepoOwner: Azure
  RepoName: azure-sdk-tools
  PushArgs:
  WorkingDirectory: $(System.DefaultWorkingDirectory)
  PRTitle: "I am test."
  ScriptDirectory: eng/common/scripts
  GHReviewersVariable: '' 
  GHTeamReviewersVariable: ''
  PRLabel: ''

steps:
- task: PowerShell@2
  displayName: Create pull request
  condition: and(succeeded(), eq(variables['HasChanges'], 'true'))
  inputs:
    pwsh: true
    workingDirectory: ${{ parameters.WorkingDirectory }}
    filePath: ${{ parameters.ScriptDirectory }}/Submit-PullRequest.ps1
    arguments: >
      -RepoOwner "${{ parameters.RepoOwner }}"
      -RepoName "${{ parameters.RepoName }}"
      -BaseBranch "${{ parameters.BaseBranchName }}"
      -PROwner "${{ parameters.PROwner }}"
      -PRBranch "${{ parameters.PRBranchName }}"
      -AuthToken "$(azuresdk-github-pat)"
      -PRTitle "${{ parameters.PRTitle }}"

- task: PowerShell@2
  displayName: Tag a Reviewer on PR
  condition: and(succeeded(), eq(variables['HasChanges'], 'true'))
  inputs:
    pwsh: true
    workingDirectory: ${{ parameters.WorkingDirectory }}
    filePath: ${{ parameters.ScriptDirectory }}/add-pullrequest-reviewers.ps1
    arguments: >
      -RepoOwner "${{ parameters.RepoOwner }}"
      -RepoName "${{ parameters.RepoName }}"
      -AuthToken "$(azuresdk-github-pat)"
      -GitHubUsers "$(${{ parameters.GHReviewersVariable }})"
      -GitHubTeams "$(${{ parameters.GHTeamReviewersVariable }})"
      -PRNumber "$(Submitted.PullRequest.Number)"

- task: PowerShell@2
  displayName: Add a label to PR
  condition: and(succeeded(), eq(variables['HasChanges'], 'true'))
  inputs:
    pwsh: true
    workingDirectory: ${{ parameters.WorkingDirectory }}
    filePath: ${{ parameters.ScriptDirectory }}/add-pullrequest-labels.ps1
    arguments: >
      -RepoOwner "${{ parameters.RepoOwner }}"
      -RepoName "${{ parameters.RepoName }}"
      -AuthToken "$(azuresdk-github-pat)"
      -PRNumber "$(Submitted.PullRequest.Number)"
      -PRLabel "$(PRLabel)"
      -AuthToken "$(azuresdk-github-pat)"
